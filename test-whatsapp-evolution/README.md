# WhatsApp Bot con OpenAI - Evolution API

Este m√≥dulo implementa un bot de WhatsApp inteligente para Pasteur Laboratorios Cl√≠nicos que utiliza la API de OpenAI con capacidad de function calling para responder autom√°ticamente a mensajes de clientes.

## üöÄ Caracter√≠sticas

- **Procesamiento inteligente de mensajes** usando GPT-4 Turbo
- **Function Calling** para ejecutar acciones espec√≠ficas:
  - Listar y buscar usuarios
  - Consultar ex√°menes m√©dicos
  - Obtener informaci√≥n de citas
  - Enviar ex√°menes por correo
  - B√∫squeda de informaci√≥n sobre ex√°menes (RAG)
  - B√∫squeda de informaci√≥n del laboratorio (RAG)
  - Verificar disponibilidad de citas
  - Crear y eliminar citas
- **Gesti√≥n de historial de conversaci√≥n** para contexto en las respuestas
- **Respuestas autom√°ticas** personalizadas y profesionales
- **Integraci√≥n con Evolution API** para WhatsApp

## üìã Requisitos Previos

1. **Python 3.8+**
2. **OpenAI API Key** - Configurada en `.env`
3. **Evolution API** - Instancia configurada y funcionando
4. **Redis** - Para las funciones RAG
5. **Base de datos** - SQLite con los datos de usuarios y ex√°menes (ubicada en el directorio ra√≠z del proyecto)

> **Nota sobre la Base de Datos**: El webhook autom√°ticamente usa la base de datos `database.db` del directorio ra√≠z del proyecto. No necesitas copiarla a `test-whatsapp-evolution/`.

## üîß Configuraci√≥n

### 1. Variables de Entorno

Crea un archivo `.env` en la ra√≠z del proyecto con:

```env
OPENAI_API_KEY=tu_api_key_aqu√≠
```

### 2. Configuraci√≥n de Evolution API

En `webhook.py`, actualiza las siguientes constantes:

```python
EVOLUTION_API_URL = "https://tu-evolution-api.com"
EVOLUTION_API_KEY = "tu_api_key"
INSTANCE_NAME = "nombre_de_tu_instancia"
```

### 3. Instalaci√≥n de Dependencias

Las dependencias ya est√°n incluidas en `requirements.txt` del proyecto principal:

```bash
pip install -r requirements.txt
```

Principales dependencias:
- `openai` - Para la API de OpenAI
- `fastapi` - Framework web
- `httpx` - Cliente HTTP as√≠ncrono
- `pydantic` - Validaci√≥n de datos
- `python-dotenv` - Gesti√≥n de variables de entorno

### 4. Configuraci√≥n de la Base de Datos

El webhook usa autom√°ticamente la base de datos del directorio ra√≠z del proyecto. Si a√∫n no has inicializado la base de datos, ejecuta desde la ra√≠z del proyecto:

```bash
# Desde el directorio ra√≠z (openai-realtime-twilio)
python init_db.py
```

Esto crear√° `database.db` con las tablas necesarias:
- `usuarios` - Informaci√≥n de pacientes
- `examenes_medicos` - Resultados de ex√°menes
- `cita_examen_medico` - Citas programadas

El sistema autom√°ticamente detecta y usa esta base de datos cuando se ejecuta desde `test-whatsapp-evolution/`.

## üéØ C√≥mo Funciona

### Flujo de Procesamiento de Mensajes

1. **Recepci√≥n del Webhook**
   - Evolution API env√≠a un webhook cuando llega un mensaje
   - El endpoint `/webhook/evolution` recibe el evento

2. **Gesti√≥n del Historial**
   - Se obtienen los √∫ltimos 5 mensajes de la conversaci√≥n
   - Se construye un historial de contexto para OpenAI

3. **Procesamiento con OpenAI**
   - Se env√≠a el historial y el mensaje actual a GPT-4 Turbo
   - El modelo decide si necesita usar alguna herramienta (function calling)
   - Si hay function calls, se ejecutan usando `FunctionManager`

4. **Ejecuci√≥n de Funciones**
   - Las funciones se ejecutan de forma as√≠ncrona
   - Los resultados se env√≠an de vuelta a OpenAI
   - OpenAI genera una respuesta final basada en los resultados

5. **Respuesta al Usuario**
   - La respuesta final se env√≠a por WhatsApp usando Evolution API
   - Se guarda en el historial para futuras conversaciones

### System Prompt

El bot utiliza un system prompt detallado basado en `realtime_config.py` pero adaptado para mensajes de texto. El prompt incluye:

- **Personalidad**: Juliana, asistente profesional y c√°lida de Pasteur
- **Contexto de la empresa**: Historia, servicios, tecnolog√≠a
- **Instrucciones de uso de herramientas**: Cu√°ndo y c√≥mo usar cada funci√≥n
- **Reglas de conversaci√≥n**: Tono, formato, estructura de respuestas
- **Manejo de situaciones especiales**: Errores, escalaci√≥n, etc.

## üõ†Ô∏è Funciones Disponibles (Function Calling)

### Gesti√≥n de Usuarios
- `listar_usuarios()` - Lista todos los usuarios
- `obtener_usuario(identificacion)` - Obtiene un usuario por c√©dula

### Gesti√≥n de Ex√°menes
- `obtener_examenes_medicos(id_usuario)` - Consulta ex√°menes de un usuario
- `send_email_with_file(...)` - Env√≠a ex√°menes por correo

### Gesti√≥n de Citas
- `obtener_cita_examen_medico(id_usuario)` - Consulta citas de un usuario
- `verificar_disponibilidad_citas(fecha_cita, ciudad)` - Verifica disponibilidad
- `crear_cita(...)` - Crea una nueva cita
- `eliminar_cita(id)` - Elimina una cita
- `obtener_citas_activas_usuario(id_usuario)` - Lista citas activas

### Informaci√≥n General (RAG)
- `search_general_exam_info(query, num_results)` - Busca info sobre ex√°menes
- `search_info_about_the_lab(query, num_results)` - Busca info del laboratorio

## üö¶ Inicio del Servidor

### Antes de Iniciar

Aseg√∫rate de que:
1. La base de datos est√© inicializada (ejecutar `python init_db.py` desde la ra√≠z)
2. El archivo `.env` est√© configurado en la ra√≠z con `OPENAI_API_KEY`
3. Redis est√© corriendo (para funciones RAG)

### Desarrollo

```bash
cd test-whatsapp-evolution
python webhook.py
```

Al iniciar, deber√≠as ver:
```
üìä Usando base de datos: /ruta/completa/database.db
üîß Funciones de database detectadas: ['crear_cita', 'eliminar_cita', 'listar_usuarios', ...]
INFO:     Started server process...
```

El sistema detecta autom√°ticamente qu√© funciones necesitan acceso a la base de datos.

El servidor se iniciar√° en `http://0.0.0.0:8000`

### Producci√≥n con Uvicorn

```bash
cd test-whatsapp-evolution
uvicorn webhook:app --host 0.0.0.0 --port 8000 --reload
```

## üì° Endpoints Disponibles

### POST `/webhook/evolution`
Recibe webhooks de Evolution API

**Eventos soportados:**
- `messages.upsert` - Mensajes nuevos o actualizados
- `connection.update` - Actualizaciones de conexi√≥n

### GET `/messages/{remote_jid}`
Obtiene mensajes de un chat espec√≠fico

**Par√°metros:**
- `remote_jid` - ID del chat (ej: `573001234567@s.whatsapp.net`)
- `limit` - Cantidad de mensajes (default: 5)
- `page` - P√°gina (default: 1)

### GET `/chats`
Lista todos los chats en memoria local

### GET `/`
Estado del servidor y endpoints disponibles

## üîç Logs y Debug

El sistema imprime logs detallados:

```
‚úì Mensaje recibido de Usuario
ü§ñ Procesando con OpenAI...
üìù Mensajes enviados: 3
üîß Se detectaron 2 function calls
   üìû Ejecutando: listar_usuarios
   ‚úì Resultado: [...]
   üìû Ejecutando: obtener_examenes_medicos
   ‚úì Resultado: [...]
ü§ñ Segunda llamada a OpenAI con resultados de funciones...
‚úì Respuesta generada: Hola! üëã...
üì§ Enviando respuesta por WhatsApp...
‚úì Mensaje enviado exitosamente
‚úì Conversaci√≥n completada exitosamente
```

## üîí Seguridad

- **Validaci√≥n de mensajes**: Solo responde a mensajes de usuarios (no responde a sus propios mensajes)
- **Validaci√≥n de contenido**: Ignora mensajes sin texto v√°lido (im√°genes, stickers, etc. sin caption)
- **Manejo de errores**: Todos los errores se capturan y registran sin detener el servicio
- **Variables de entorno**: API keys y credenciales en `.env` (no en c√≥digo)

## üì± Configuraci√≥n del Webhook en Evolution API

1. Accede a tu instancia de Evolution API
2. Configura el webhook URL: `https://tu-servidor.com/webhook/evolution`
3. Habilita los eventos:
   - `messages.upsert`
   - `connection.update`

## üé® Personalizaci√≥n

### Modificar el System Prompt

Edita la funci√≥n `get_text_assistant_prompt()` en `webhook.py` para ajustar:
- Personalidad del asistente
- Tono de las respuestas
- Instrucciones espec√≠ficas
- Reglas de conversaci√≥n

### Agregar Nuevas Funciones

1. Define la funci√≥n en `functions.py`
2. Agrega la descripci√≥n al array `tools` en `functions.py`
3. Registra la funci√≥n en `available_functions`
4. Actualiza el system prompt con instrucciones de uso

### Cambiar el Modelo de OpenAI

En `process_message_with_openai()`, cambia:

```python
model="gpt-4-turbo-preview"  # o "gpt-4o", "gpt-3.5-turbo", etc.
```

## üêõ Soluci√≥n de Problemas

### Error: "no such table: usuarios"
Este error indica que la base de datos no est√° inicializada correctamente.

**Soluci√≥n:**
```bash
# Desde el directorio ra√≠z del proyecto
cd ..
python init_db.py
```

El sistema usa autom√°ticamente la base de datos del directorio ra√≠z. Al iniciar el webhook, deber√≠as ver:
```
üìä Usando base de datos: /ruta/completa/database.db
```

### Error: "OpenAI API Key not found"
- Verifica que existe `.env` en la ra√≠z del proyecto con `OPENAI_API_KEY`
- Aseg√∫rate de que `load_dotenv()` se est√° ejecutando
- El `.env` debe estar en el directorio ra√≠z, no en `test-whatsapp-evolution/`

### Error: "Function not found"
- Verifica que la funci√≥n est√© registrada en `available_functions` (en `functions.py`)
- Revisa que el nombre coincida exactamente con el tool

### No responde a mensajes
- Verifica que el webhook est√© configurado en Evolution API
- Revisa los logs para ver si llegan los eventos
- Confirma que `from_me` sea `False` (no responde a sus propios mensajes)
- Verifica que el mensaje tenga texto v√°lido (no solo im√°genes o stickers)

### Error ejecutando funciones de database
- Verifica que `database.db` exista en el directorio ra√≠z
- Ejecuta `python init_db.py` desde la ra√≠z si es necesario
- Revisa que el mensaje de inicio muestre la ruta correcta: `üìä Usando base de datos: ...`

### Error en funciones RAG (search_general_exam_info, search_info_about_the_lab)
- Confirma que Redis est√© corriendo: `redis-cli ping` (deber√≠a responder `PONG`)
- Verifica que los √≠ndices est√©n creados ejecutando los scripts en `scripts/`
- Revisa que `OPENAI_API_KEY` est√© configurada (RAG usa embeddings de OpenAI)

## üìä Ejemplo de Conversaci√≥n

**Usuario:** Hola, quiero consultar mis ex√°menes

**Bot:** Hola! üëã Soy Juliana, asistente virtual de Pasteur Laboratorios. Con gusto te ayudo a consultar tus ex√°menes.

Para ayudarte mejor, ¬øme puedes decir tu nombre completo por favor?

**Usuario:** Juan P√©rez

**Bot:** Perfecto Juan. D√©jame buscar tus ex√°menes disponibles...

*[Ejecuta: listar_usuarios(), obtener_examenes_medicos()]*

Encontr√© los siguientes ex√°menes disponibles:

üìã *Examen de Sangre Completo*
- Fecha: 2025-10-15
- Estado: Disponible

üìã *Examen de Orina*
- Fecha: 2025-10-15
- Estado: Disponible

¬øQuieres que te los env√≠e por correo?

## üìÑ Licencia

Este m√≥dulo es parte del proyecto Pasteur Laboratorios Cl√≠nicos.

## üë• Soporte

Para soporte o preguntas, contacta al equipo de desarrollo.

